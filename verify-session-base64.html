<!DOCTYPE html>
<html>
<head>
  <title>Session BASE64 Ellen≈ërz≈ë</title>
  <meta charset="UTF-8">
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    .input-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
      color: #333;
    }
    input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 5px;
      box-sizing: border-box;
    }
    button {
      background: #4CAF50;
      color: white;
      padding: 15px 30px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      width: 100%;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .result {
      margin-top: 30px;
      padding: 20px;
      border-radius: 5px;
      display: none;
    }
    .result.success {
      background: #d4edda;
      border: 2px solid #28a745;
      color: #155724;
      display: block;
    }
    .result.error {
      background: #f8d7da;
      border: 2px solid #dc3545;
      color: #721c24;
      display: block;
    }
    .result.warning {
      background: #fff3cd;
      border: 2px solid #ffc107;
      color: #856404;
      display: block;
    }
    .result h3 {
      margin-top: 0;
      font-size: 20px;
    }
    .result ul {
      margin: 10px 0;
      padding-left: 20px;
    }
    .result li {
      margin: 5px 0;
    }
    .code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }
    .image-preview {
      margin-top: 20px;
      max-width: 100%;
      border: 2px solid #ddd;
      border-radius: 5px;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Session BASE64 Ellen≈ërz≈ë</h1>
    <p class="subtitle">Ellen≈ërizd, hogy a munkamenet BASE64 k√©peket tartalmaz-e (JSON import kompatibilis)</p>
    
    <div class="input-group">
      <label for="sessionCode">Munkamenet k√≥d:</label>
      <input 
        type="text" 
        id="sessionCode" 
        placeholder="Pl: UK1S5P, J7ZD9J, XYZ123" 
        style="text-transform: uppercase;"
      />
    </div>
    
    <button onclick="checkSession()">üîç Ellen≈ërz√©s</button>
    
    <div id="loading" class="loading" style="display: none;">
      ‚è≥ Bet√∂lt√©s...
    </div>
    
    <div id="result" class="result"></div>
  </div>

  <script>
    async function checkSession() {
      const sessionCode = document.getElementById('sessionCode').value.trim().toUpperCase();
      const resultDiv = document.getElementById('result');
      const loadingDiv = document.getElementById('loading');
      
      if (!sessionCode) {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = '<h3>‚ùå Hiba</h3><p>K√©rlek add meg a munkamenet k√≥dot!</p>';
        return;
      }
      
      // Show loading
      loadingDiv.style.display = 'block';
      resultDiv.style.display = 'none';
      
      try {
        // Fetch session from API
        const response = await fetch(`/api/simple-api/sessions/${sessionCode}/download`);
        
        if (!response.ok) {
          resultDiv.className = 'result error';
          resultDiv.innerHTML = `
            <h3>‚ùå Munkamenet nem tal√°lhat√≥</h3>
            <p>A <span class="code">${sessionCode}</span> k√≥d√∫ munkamenet nem l√©tezik a Supabase-ben.</p>
            <ul>
              <li>Ellen≈ërizd, hogy j√≥l √≠rtad-e be a k√≥dot</li>
              <li>Lehet, hogy a munkamenet t√∫l r√©gi √©s m√°r t√∂r√∂lve lett</li>
              <li>Lehet, hogy a munkamenet m√©g nem lett l√©trehozva</li>
            </ul>
          `;
          loadingDiv.style.display = 'none';
          return;
        }
        
        const sessionData = await response.json();
        
        // Check if session has exercises
        if (!sessionData.exercises || sessionData.exercises.length === 0) {
          resultDiv.className = 'result error';
          resultDiv.innerHTML = `
            <h3>‚ùå Nincs feladat</h3>
            <p>A munkamenet nem tartalmaz feladatokat.</p>
          `;
          loadingDiv.style.display = 'none';
          return;
        }
        
        // Check first exercise image
        const firstExercise = sessionData.exercises[0];
        const imageUrl = firstExercise.imageUrl;
        
        if (!imageUrl) {
          resultDiv.className = 'result error';
          resultDiv.innerHTML = `
            <h3>‚ùå Nincs k√©p</h3>
            <p>Az els≈ë feladat nem tartalmaz k√©pet.</p>
          `;
          loadingDiv.style.display = 'none';
          return;
        }
        
        // Check image type
        const imageLength = imageUrl.length;
        const isBase64 = imageUrl.startsWith('data:image/');
        const isDriveUrl = imageUrl.includes('drive.google.com');
        const isMockUrl = imageLength < 200;
        
        // Calculate total size
        let totalBase64Size = 0;
        let base64Count = 0;
        sessionData.exercises.forEach(ex => {
          if (ex.imageUrl && ex.imageUrl.startsWith('data:image/')) {
            totalBase64Size += ex.imageUrl.length;
            base64Count++;
          }
        });
        
        if (isBase64) {
          // SUCCESS - BASE64 images
          resultDiv.className = 'result success';
          resultDiv.innerHTML = `
            <h3>‚úÖ T√ñK√âLETES! BASE64 k√©pek</h3>
            <p>Ez a munkamenet <strong>K√âSZEN √ÅLL</strong> a JSON importra!</p>
            <ul>
              <li><strong>Munkamenet k√≥d:</strong> <span class="code">${sessionData.code || sessionData.sessionCode}</span></li>
              <li><strong>Tant√°rgy:</strong> ${sessionData.subject || 'N/A'}</li>
              <li><strong>Oszt√°ly:</strong> ${sessionData.className || 'N/A'}</li>
              <li><strong>Feladatok sz√°ma:</strong> ${sessionData.exercises.length}</li>
              <li><strong>BASE64 k√©pek:</strong> ${base64Count} / ${sessionData.exercises.length}</li>
              <li><strong>Els≈ë k√©p m√©rete:</strong> ${formatBytes(imageLength)}</li>
              <li><strong>√ñsszes k√©p m√©rete:</strong> ${formatBytes(totalBase64Size)}</li>
            </ul>
            <p><strong>üéâ K√∂vetkez≈ë l√©p√©sek:</strong></p>
            <ol>
              <li>Kattints a "K√©pek felt√∂lt√©se Google Drive-ra" gombra</li>
              <li>T√∂ltsd le a JSON f√°jlt (${formatBytes(totalBase64Size + 10000)} k√∂r√ºl)</li>
              <li>Oszd meg a di√°kokkal (Google Drive / USB / h√°l√≥zat)</li>
              <li>Di√°kok bet√∂lthetik a "JSON f√°jl bet√∂lt√©se" gombbal</li>
              <li>K√©pek megjelennek offline is! ‚úÖ</li>
            </ol>
            <img src="${imageUrl}" class="image-preview" alt="Els≈ë feladat k√©pe" />
          `;
        } else if (isMockUrl) {
          // ERROR - Mock URL (old session)
          resultDiv.className = 'result error';
          resultDiv.innerHTML = `
            <h3>‚ùå R√âGI MUNKAMENET - Mock URL</h3>
            <p>Ez a munkamenet <strong>A FIX EL≈êTT</strong> lett l√©trehozva √©s <strong>NEM M≈∞K√ñDIK</strong> a JSON importtal.</p>
            <ul>
              <li><strong>Munkamenet k√≥d:</strong> <span class="code">${sessionData.code || sessionData.sessionCode}</span></li>
              <li><strong>K√©p t√≠pus:</strong> Mock Google Drive URL</li>
              <li><strong>K√©p hossz:</strong> ${imageLength} karakter (t√∫l r√∂vid!)</li>
              <li><strong>URL p√©lda:</strong> <span class="code">${imageUrl.substring(0, 50)}...</span></li>
            </ul>
            <p><strong>‚ö†Ô∏è PROBL√âMA:</strong></p>
            <ul>
              <li>Ez egy hamis URL, nem l√©tez≈ë Google Drive f√°jlra mutat</li>
              <li>A JSON import nem fog m≈±k√∂dni ezzel a munkamenettel</li>
              <li>A k√©pek nem fognak megjelenni</li>
            </ul>
            <p><strong>‚úÖ MEGOLD√ÅS:</strong></p>
            <ol>
              <li><strong>Hozz l√©tre egy TELJESEN √öJ munkamenetet</strong></li>
              <li>NE haszn√°ld a r√©gi k√≥dokat (J7ZD9J, 0Z52CH, U9K5JH, stb.)</li>
              <li>Az √∫j munkamenet BASE64 k√©peket fog tartalmazni</li>
              <li>Ellen≈ërizd √∫jra ezzel a tool-lal</li>
            </ol>
          `;
        } else if (isDriveUrl) {
          // WARNING - Real Drive URL
          resultDiv.className = 'result warning';
          resultDiv.innerHTML = `
            <h3>‚ö†Ô∏è Google Drive URL</h3>
            <p>Ez a munkamenet Google Drive linkeket haszn√°l.</p>
            <ul>
              <li><strong>Munkamenet k√≥d:</strong> <span class="code">${sessionData.code || sessionData.sessionCode}</span></li>
              <li><strong>K√©p t√≠pus:</strong> Google Drive URL</li>
              <li><strong>K√©p hossz:</strong> ${imageLength} karakter</li>
            </ul>
            <p><strong>üí° MEGJEGYZ√âS:</strong></p>
            <ul>
              <li>Ez m≈±k√∂dhet, ha a Drive f√°jlok l√©teznek √©s publikusak</li>
              <li>Offline haszn√°lathoz BASE64 k√©pek jobbak</li>
              <li>Ha offline JSON importot szeretn√©l, hozz l√©tre √∫j munkamenetet</li>
            </ul>
          `;
        } else {
          // UNKNOWN
          resultDiv.className = 'result warning';
          resultDiv.innerHTML = `
            <h3>‚ùì Ismeretlen k√©p form√°tum</h3>
            <p>A k√©p form√°tuma nem ismerhet≈ë fel.</p>
            <ul>
              <li><strong>K√©p hossz:</strong> ${imageLength} karakter</li>
              <li><strong>URL kezdete:</strong> <span class="code">${imageUrl.substring(0, 100)}...</span></li>
            </ul>
          `;
        }
        
      } catch (error) {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = `
          <h3>‚ùå Hiba t√∂rt√©nt</h3>
          <p>${error.message}</p>
        `;
      } finally {
        loadingDiv.style.display = 'none';
      }
    }
    
    function formatBytes(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
    
    // Auto-load session code from URL
    const urlParams = new URLSearchParams(window.location.search);
    const codeParam = urlParams.get('code');
    if (codeParam) {
      document.getElementById('sessionCode').value = codeParam;
      checkSession();
    }
  </script>
</body>
</html>
