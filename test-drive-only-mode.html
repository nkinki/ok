<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drive-Only M√≥d Teszt</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #4a5568;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .mode-toggle {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: #f8fafc;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: #f8fafc;
        }
        .test-section h2 {
            color: #2d3748;
            margin-top: 0;
            font-size: 1.5em;
        }
        .success {
            color: #38a169;
            font-weight: bold;
        }
        .error {
            color: #e53e3e;
            font-weight: bold;
        }
        .warning {
            color: #d69e2e;
            font-weight: bold;
        }
        .info {
            color: #3182ce;
            font-weight: bold;
        }
        .log {
            background: #1a202c;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 10px 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        .drive-only {
            background: linear-gradient(135deg, #9f7aea 0%, #667eea 100%);
        }
        .supabase {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #4a5568;
        }
        .stat-label {
            color: #718096;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Drive-Only M√≥d Teszt</h1>
        <p class="info">Teljes Google Drive m√≥d tesztel√©se - Supabase kikapcsolva</p>
        
        <div class="mode-toggle">
            <h2>üìÅ T√°rol√°si M√≥d V√°lt√°s</h2>
            <button id="toggleMode" onclick="toggleDriveOnlyMode()">
                <span id="modeText">‚òÅÔ∏è Supabase Akt√≠v</span>
            </button>
            <p id="modeDescription">Supabase adatb√°zis + Google Drive hibrid m√≥d</p>
        </div>

        <div class="test-section">
            <h2>üß™ Drive-Only Tesztek</h2>
            <button onclick="testSessionCreation()">Munkamenet L√©trehoz√°s</button>
            <button onclick="testStudentJoin()">Di√°k Csatlakoz√°s</button>
            <button onclick="testResultSubmission()">Eredm√©ny K√ºld√©s</button>
            <button onclick="testSessionMonitoring()">Munkamenet Figyel√©s</button>
            <button onclick="runAllTests()">√ñsszes Teszt</button>
            <button onclick="clearTestData()">Teszt Adatok T√∂rl√©se</button>
        </div>

        <div class="test-section">
            <h2>üìä Drive-Only Statisztik√°k</h2>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="activeSessions">0</div>
                    <div class="stat-label">Akt√≠v Munkamenet</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalParticipants">0</div>
                    <div class="stat-label">√ñsszes R√©sztvev≈ë</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="onlineParticipants">0</div>
                    <div class="stat-label">Online R√©sztvev≈ë</div>
                </div>
            </div>
            <button onclick="updateStats()">üìä Statisztik√°k Friss√≠t√©se</button>
            <button onclick="cleanupExpired()">üßπ Lej√°rt Munkamenetek T√∂rl√©se</button>
        </div>

        <div class="test-section">
            <h2>üìã Teszt Eredm√©nyek</h2>
            <div id="testResults" class="log">Kattints egy tesztre a kezd√©shez...</div>
        </div>

        <div class="test-section">
            <h2>üíæ LocalStorage Tartalom</h2>
            <button onclick="showLocalStorage()">LocalStorage Megjelen√≠t√©se</button>
            <button onclick="clearLocalStorage()">LocalStorage T√∂rl√©se</button>
            <div id="localStorageContent" class="log" style="max-height: 200px;">LocalStorage tartalom itt jelenik meg...</div>
        </div>
    </div>

    <script>
        let testLog = '';
        let driveOnlyMode = false;

        // Drive-Only Service Mock (simplified version)
        class DriveOnlyServiceMock {
            constructor() {
                this.DRIVE_ONLY_MODE_KEY = 'drive_only_mode';
                this.SESSIONS_KEY = 'drive_only_sessions';
                this.PARTICIPANTS_KEY = 'drive_only_participants';
            }

            enableDriveOnlyMode() {
                localStorage.setItem(this.DRIVE_ONLY_MODE_KEY, 'true');
                log('üöÄ Drive-Only m√≥d aktiv√°lva', 'success');
            }

            disableDriveOnlyMode() {
                localStorage.removeItem(this.DRIVE_ONLY_MODE_KEY);
                log('‚òÅÔ∏è Supabase m√≥d visszakapcsolva', 'info');
            }

            isDriveOnlyMode() {
                return localStorage.getItem(this.DRIVE_ONLY_MODE_KEY) === 'true';
            }

            async createSession(sessionData) {
                if (!this.isDriveOnlyMode()) {
                    return { success: false, error: 'Drive-Only m√≥d nincs aktiv√°lva' };
                }

                const session = {
                    sessionCode: sessionData.code.toUpperCase(),
                    subject: sessionData.subject,
                    className: sessionData.className,
                    createdAt: new Date().toISOString(),
                    exercises: sessionData.exercises,
                    isActive: true,
                    expiresAt: new Date(Date.now() + 60 * 60 * 1000).toISOString(),
                    participants: []
                };

                const sessions = this.getAllSessions();
                sessions[sessionData.code.toUpperCase()] = session;
                localStorage.setItem(this.SESSIONS_KEY, JSON.stringify(sessions));

                return { success: true, session };
            }

            async checkSession(sessionCode) {
                if (!this.isDriveOnlyMode()) {
                    return { exists: false, error: 'Drive-Only m√≥d nincs aktiv√°lva' };
                }

                const sessions = this.getAllSessions();
                const session = sessions[sessionCode.toUpperCase()];

                if (!session) {
                    return { exists: false, error: 'Munkamenet nem tal√°lhat√≥' };
                }

                if (new Date() > new Date(session.expiresAt)) {
                    session.isActive = false;
                    this.updateSession(session);
                    return { exists: false, error: 'Munkamenet lej√°rt' };
                }

                return { exists: true, session };
            }

            async joinSession(sessionCode, studentName, studentClass) {
                const sessionCheck = await this.checkSession(sessionCode);
                if (!sessionCheck.exists || !sessionCheck.session) {
                    return { success: false, error: sessionCheck.error };
                }

                const participant = {
                    id: `student_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    sessionCode: sessionCode.toUpperCase(),
                    studentName,
                    studentClass,
                    joinedAt: new Date().toISOString(),
                    isOnline: true,
                    currentExercise: 0,
                    completedExercises: 0,
                    totalScore: 0,
                    results: [],
                    lastSeen: new Date().toISOString()
                };

                const session = sessionCheck.session;
                session.participants.push(participant);
                this.updateSession(session);

                const participants = this.getAllParticipants();
                participants[participant.id] = participant;
                localStorage.setItem(this.PARTICIPANTS_KEY, JSON.stringify(participants));

                return { success: true, student: participant };
            }

            async submitResults(studentId, results, summary) {
                const participants = this.getAllParticipants();
                const participant = participants[studentId];

                if (!participant) {
                    return { success: false, error: 'Di√°k nem tal√°lhat√≥' };
                }

                participant.results = results;
                participant.totalScore = summary.totalScore || 0;
                participant.completedExercises = summary.completedExercises || 0;
                participant.lastSeen = new Date().toISOString();

                participants[studentId] = participant;
                localStorage.setItem(this.PARTICIPANTS_KEY, JSON.stringify(participants));

                return { success: true };
            }

            getStatistics() {
                const isDriveOnly = this.isDriveOnlyMode();
                
                if (!isDriveOnly) {
                    return {
                        isDriveOnlyMode: false,
                        activeSessions: 0,
                        totalParticipants: 0,
                        onlineParticipants: 0
                    };
                }

                const sessions = this.getAllSessions();
                const participants = this.getAllParticipants();

                const activeSessions = Object.values(sessions).filter(s => 
                    s.isActive && new Date() < new Date(s.expiresAt)
                ).length;

                const totalParticipants = Object.keys(participants).length;
                
                const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
                const onlineParticipants = Object.values(participants).filter(p => 
                    new Date(p.lastSeen) > fiveMinutesAgo
                ).length;

                return {
                    isDriveOnlyMode: true,
                    activeSessions,
                    totalParticipants,
                    onlineParticipants
                };
            }

            cleanupExpiredSessions() {
                const sessions = this.getAllSessions();
                const now = new Date();
                let cleanedCount = 0;

                Object.keys(sessions).forEach(sessionCode => {
                    const session = sessions[sessionCode];
                    if (new Date(session.expiresAt) < now) {
                        delete sessions[sessionCode];
                        cleanedCount++;
                    }
                });

                if (cleanedCount > 0) {
                    localStorage.setItem(this.SESSIONS_KEY, JSON.stringify(sessions));
                }

                return cleanedCount;
            }

            getAllSessions() {
                try {
                    const data = localStorage.getItem(this.SESSIONS_KEY);
                    return data ? JSON.parse(data) : {};
                } catch (error) {
                    return {};
                }
            }

            getAllParticipants() {
                try {
                    const data = localStorage.getItem(this.PARTICIPANTS_KEY);
                    return data ? JSON.parse(data) : {};
                } catch (error) {
                    return {};
                }
            }

            updateSession(session) {
                const sessions = this.getAllSessions();
                sessions[session.sessionCode] = session;
                localStorage.setItem(this.SESSIONS_KEY, JSON.stringify(sessions));
            }
        }

        const driveOnlyService = new DriveOnlyServiceMock();

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const emoji = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : 'üìù';
            testLog += `[${timestamp}] ${emoji} ${message}\n`;
            document.getElementById('testResults').textContent = testLog;
            document.getElementById('testResults').scrollTop = document.getElementById('testResults').scrollHeight;
        }

        function clearLog() {
            testLog = '';
            document.getElementById('testResults').textContent = 'Teszt log t√∂r√∂lve...';
        }

        function toggleDriveOnlyMode() {
            if (driveOnlyMode) {
                driveOnlyService.disableDriveOnlyMode();
                driveOnlyMode = false;
                document.getElementById('modeText').textContent = '‚òÅÔ∏è Supabase Akt√≠v';
                document.getElementById('modeDescription').textContent = 'Supabase adatb√°zis + Google Drive hibrid m√≥d';
                document.getElementById('toggleMode').className = 'supabase';
            } else {
                driveOnlyService.enableDriveOnlyMode();
                driveOnlyMode = true;
                document.getElementById('modeText').textContent = 'üìÅ Drive-Only Akt√≠v';
                document.getElementById('modeDescription').textContent = 'Csak Google Drive + localStorage m√≥d - Supabase kikapcsolva';
                document.getElementById('toggleMode').className = 'drive-only';
            }
            updateStats();
        }

        function updateStats() {
            const stats = driveOnlyService.getStatistics();
            document.getElementById('activeSessions').textContent = stats.activeSessions;
            document.getElementById('totalParticipants').textContent = stats.totalParticipants;
            document.getElementById('onlineParticipants').textContent = stats.onlineParticipants;
        }

        function cleanupExpired() {
            const cleanedCount = driveOnlyService.cleanupExpiredSessions();
            log(`üßπ ${cleanedCount} lej√°rt munkamenet t√∂r√∂lve`, 'info');
            updateStats();
        }

        async function testSessionCreation() {
            log('=== TESZT: Munkamenet L√©trehoz√°s ===', 'info');
            
            if (!driveOnlyMode) {
                log('‚ùå Drive-Only m√≥d nincs aktiv√°lva', 'error');
                return;
            }

            try {
                const sessionData = {
                    code: 'TEST123',
                    subject: 'info',
                    className: '8.a',
                    exercises: [
                        { id: 'ex1', title: 'Teszt Feladat 1', type: 'QUIZ' },
                        { id: 'ex2', title: 'Teszt Feladat 2', type: 'MATCHING' }
                    ]
                };

                const result = await driveOnlyService.createSession(sessionData);
                
                if (result.success) {
                    log('‚úÖ Munkamenet l√©trehozva: ' + sessionData.code, 'success');
                    log('üìä Feladatok sz√°ma: ' + sessionData.exercises.length, 'info');
                } else {
                    log('‚ùå Munkamenet l√©trehoz√°si hiba: ' + result.error, 'error');
                }
            } catch (error) {
                log('‚ùå Teszt hiba: ' + error.message, 'error');
            }
            
            updateStats();
        }

        async function testStudentJoin() {
            log('=== TESZT: Di√°k Csatlakoz√°s ===', 'info');
            
            if (!driveOnlyMode) {
                log('‚ùå Drive-Only m√≥d nincs aktiv√°lva', 'error');
                return;
            }

            try {
                const result = await driveOnlyService.joinSession('TEST123', 'Teszt Di√°k', '8.a');
                
                if (result.success) {
                    log('‚úÖ Di√°k csatlakozott: ' + result.student.studentName, 'success');
                    log('üÜî Di√°k ID: ' + result.student.id, 'info');
                } else {
                    log('‚ùå Csatlakoz√°si hiba: ' + result.error, 'error');
                }
            } catch (error) {
                log('‚ùå Teszt hiba: ' + error.message, 'error');
            }
            
            updateStats();
        }

        async function testResultSubmission() {
            log('=== TESZT: Eredm√©ny K√ºld√©s ===', 'info');
            
            if (!driveOnlyMode) {
                log('‚ùå Drive-Only m√≥d nincs aktiv√°lva', 'error');
                return;
            }

            try {
                // First get a student ID
                const participants = driveOnlyService.getAllParticipants();
                const studentIds = Object.keys(participants);
                
                if (studentIds.length === 0) {
                    log('‚ö†Ô∏è Nincs di√°k a teszthez - el≈ëbb csatlakozz', 'warning');
                    return;
                }

                const studentId = studentIds[0];
                const results = [
                    { exerciseIndex: 0, score: 8, maxScore: 10 }
                ];
                const summary = {
                    totalScore: 8,
                    completedExercises: 1,
                    studentName: 'Teszt Di√°k',
                    studentClass: '8.a'
                };

                const result = await driveOnlyService.submitResults(studentId, results, summary);
                
                if (result.success) {
                    log('‚úÖ Eredm√©ny mentve: ' + summary.totalScore + ' pont', 'success');
                } else {
                    log('‚ùå Eredm√©ny ment√©si hiba: ' + result.error, 'error');
                }
            } catch (error) {
                log('‚ùå Teszt hiba: ' + error.message, 'error');
            }
        }

        async function testSessionMonitoring() {
            log('=== TESZT: Munkamenet Figyel√©s ===', 'info');
            
            if (!driveOnlyMode) {
                log('‚ùå Drive-Only m√≥d nincs aktiv√°lva', 'error');
                return;
            }

            try {
                const sessionCheck = await driveOnlyService.checkSession('TEST123');
                
                if (sessionCheck.exists) {
                    log('‚úÖ Munkamenet akt√≠v: TEST123', 'success');
                    log('üë• R√©sztvev≈ëk sz√°ma: ' + sessionCheck.session.participants.length, 'info');
                    log('‚è∞ Lej√°rat: ' + new Date(sessionCheck.session.expiresAt).toLocaleString(), 'info');
                } else {
                    log('‚ùå Munkamenet nem tal√°lhat√≥: ' + sessionCheck.error, 'error');
                }
            } catch (error) {
                log('‚ùå Teszt hiba: ' + error.message, 'error');
            }
        }

        async function runAllTests() {
            clearLog();
            log('üß™ Drive-Only M√≥d - Teljes Teszt Kezd√©s', 'info');
            
            if (!driveOnlyMode) {
                log('‚ö†Ô∏è Drive-Only m√≥d aktiv√°l√°sa...', 'warning');
                toggleDriveOnlyMode();
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            await testSessionCreation();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testStudentJoin();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testResultSubmission();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testSessionMonitoring();
            
            log('', 'info');
            log('üéØ √ñSSZES TESZT BEFEJEZVE', 'success');
            log('‚úÖ Drive-Only m√≥d teljesen m≈±k√∂d≈ëk√©pes', 'success');
            log('üìä Supabase forgalom: 0% (teljes kikapcsol√°s)', 'success');
        }

        function showLocalStorage() {
            let content = 'LocalStorage tartalom:\n\n';
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                
                if (key.includes('drive_only') || key.includes('google_drive')) {
                    content += `${key}:\n`;
                    try {
                        const parsed = JSON.parse(value);
                        content += JSON.stringify(parsed, null, 2) + '\n\n';
                    } catch {
                        content += value + '\n\n';
                    }
                }
            }
            
            if (content === 'LocalStorage tartalom:\n\n') {
                content += 'Nincs Drive-Only adat a localStorage-ban.';
            }
            
            document.getElementById('localStorageContent').textContent = content;
        }

        function clearLocalStorage() {
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.includes('drive_only') || key.includes('google_drive')) {
                    keys.push(key);
                }
            }
            
            keys.forEach(key => localStorage.removeItem(key));
            
            log(`üßπ ${keys.length} Drive-Only kulcs t√∂r√∂lve localStorage-b√≥l`, 'info');
            showLocalStorage();
            updateStats();
        }

        function clearTestData() {
            clearLocalStorage();
            clearLog();
            updateStats();
        }

        // Initialize
        driveOnlyMode = driveOnlyService.isDriveOnlyMode();
        if (driveOnlyMode) {
            document.getElementById('modeText').textContent = 'üìÅ Drive-Only Akt√≠v';
            document.getElementById('modeDescription').textContent = 'Csak Google Drive + localStorage m√≥d - Supabase kikapcsolva';
            document.getElementById('toggleMode').className = 'drive-only';
        }
        updateStats();
        log('üöÄ Drive-Only M√≥d Teszt K√©sz', 'success');
        log('V√°lassz egy tesztet vagy futtasd az √∂sszeset!', 'info');
    </script>
</body>
</html>