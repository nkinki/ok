<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üñºÔ∏è K√©p Bet√∂lt√©s Teszt - V√©gs≈ë Ellen≈ërz√©s</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 2px solid #ddd; border-radius: 8px; }
        .success { border-color: #4CAF50; background: #f8fff8; }
        .error { border-color: #f44336; background: #fff8f8; }
        .warning { border-color: #ff9800; background: #fff8f0; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #2196F3; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .log { background: #f0f0f0; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; margin: 10px 0; }
        .status { font-weight: bold; padding: 5px 10px; border-radius: 3px; margin: 5px 0; display: inline-block; }
        .status.ok { background: #4CAF50; color: white; }
        .status.fail { background: #f44336; color: white; }
        .status.pending { background: #ff9800; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñºÔ∏è K√©p Bet√∂lt√©s Teszt - V√©gs≈ë Ellen≈ërz√©s</h1>
        <p>Ez a teszt ellen≈ërzi, hogy a leg√∫jabb jav√≠t√°sok ut√°n m≈±k√∂dik-e a k√©pek bet√∂lt√©se a di√°kok sz√°m√°ra.</p>

        <div class="test-section" id="step1">
            <h3>1. l√©p√©s: Adatb√°zis kapcsolat tesztel√©se</h3>
            <button class="btn-primary" onclick="testDatabaseConnection()">üîó Adatb√°zis Teszt</button>
            <div id="db-status" class="status pending">V√°rakoz√°s...</div>
            <div id="db-log" class="log" style="display:none;"></div>
        </div>

        <div class="test-section" id="step2">
            <h3>2. l√©p√©s: Munkamenet l√©trehoz√°s tesztel√©se</h3>
            <button class="btn-primary" onclick="testSessionCreation()">üéØ Munkamenet Teszt</button>
            <div id="session-status" class="status pending">V√°rakoz√°s...</div>
            <div id="session-log" class="log" style="display:none;"></div>
        </div>

        <div class="test-section" id="step3">
            <h3>3. l√©p√©s: JSON felt√∂lt√©s tesztel√©se (k√©pekkel)</h3>
            <button class="btn-primary" onclick="testJsonUpload()">üì§ JSON Felt√∂lt√©s Teszt</button>
            <div id="upload-status" class="status pending">V√°rakoz√°s...</div>
            <div id="upload-log" class="log" style="display:none;"></div>
        </div>

        <div class="test-section" id="step4">
            <h3>4. l√©p√©s: JSON let√∂lt√©s tesztel√©se (di√°k oldal)</h3>
            <button class="btn-primary" onclick="testJsonDownload()">üì• JSON Let√∂lt√©s Teszt</button>
            <div id="download-status" class="status pending">V√°rakoz√°s...</div>
            <div id="download-log" class="log" style="display:none;"></div>
        </div>

        <div class="test-section" id="final-result">
            <h3>üèÅ V√©gs≈ë Eredm√©ny</h3>
            <div id="final-status" class="status pending">Tesztek futtat√°sa sz√ºks√©ges</div>
            <div id="final-summary" style="margin-top: 10px;"></div>
        </div>

        <div class="test-section">
            <h3>üöÄ Gyors Teszt - Teljes Folyamat</h3>
            <button class="btn-success" onclick="runFullTest()">‚ñ∂Ô∏è √ñsszes Teszt Futtat√°sa</button>
            <button class="btn-warning" onclick="clearLogs()">üóëÔ∏è Logok T√∂rl√©se</button>
        </div>
    </div>

    <script>
        let testSessionCode = null;
        let testResults = {
            database: false,
            session: false,
            upload: false,
            download: false
        };

        function log(elementId, message, isError = false) {
            const logElement = document.getElementById(elementId);
            logElement.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            const prefix = isError ? '‚ùå' : '‚úÖ';
            logElement.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function setStatus(elementId, status, text) {
            const statusElement = document.getElementById(elementId);
            statusElement.className = `status ${status}`;
            statusElement.textContent = text;
        }

        async function testDatabaseConnection() {
            setStatus('db-status', 'pending', 'Tesztel√©s...');
            document.getElementById('db-log').innerHTML = '';
            
            try {
                log('db-log', 'Adatb√°zis kapcsolat tesztel√©se...');
                
                const response = await fetch('/api/simple-api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'test_connection' })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                log('db-log', `Kapcsolat OK: ${data.message}`);
                log('db-log', `Supabase URL: ${data.environment.hasSupabaseUrl ? '‚úÖ Van' : '‚ùå Hi√°nyzik'}`);
                log('db-log', `Supabase Key: ${data.environment.hasSupabaseKey ? '‚úÖ Van' : '‚ùå Hi√°nyzik'}`);
                log('db-log', `Supabase kapcsolat: ${data.supabase.canConnect ? '‚úÖ M≈±k√∂dik' : '‚ùå Hiba'}`);

                if (data.supabase.canConnect) {
                    setStatus('db-status', 'ok', '‚úÖ Adatb√°zis OK');
                    testResults.database = true;
                } else {
                    setStatus('db-status', 'fail', '‚ùå Adatb√°zis hiba');
                    log('db-log', `Hiba: ${data.supabase.error}`, true);
                }
            } catch (error) {
                setStatus('db-status', 'fail', '‚ùå Kapcsolat hiba');
                log('db-log', `Hiba: ${error.message}`, true);
            }
        }

        async function testSessionCreation() {
            setStatus('session-status', 'pending', 'Tesztel√©s...');
            document.getElementById('session-log').innerHTML = '';
            
            try {
                testSessionCode = 'TEST_' + Math.random().toString(36).substring(2, 8).toUpperCase();
                log('session-log', `Munkamenet l√©trehoz√°sa: ${testSessionCode}`);
                
                const response = await fetch('/api/simple-api/sessions/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code: testSessionCode,
                        exercises: [],
                        subject: 'test',
                        className: 'Teszt Oszt√°ly',
                        maxScore: 100
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`HTTP ${response.status}: ${errorData.error || response.statusText}`);
                }

                const data = await response.json();
                log('session-log', `Munkamenet l√©trehozva: ${data.session.code}`);
                log('session-log', `Akt√≠v: ${data.session.isActive ? 'Igen' : 'Nem'}`);
                log('session-log', `Lej√°rat: ${new Date(data.session.expiresAt).toLocaleString()}`);

                setStatus('session-status', 'ok', '‚úÖ Munkamenet OK');
                testResults.session = true;
            } catch (error) {
                setStatus('session-status', 'fail', '‚ùå Munkamenet hiba');
                log('session-log', `Hiba: ${error.message}`, true);
            }
        }

        async function testJsonUpload() {
            if (!testSessionCode) {
                setStatus('upload-status', 'fail', '‚ùå Nincs munkamenet');
                log('upload-log', 'El≈ëbb hozz l√©tre egy munkamenetet!', true);
                return;
            }

            setStatus('upload-status', 'pending', 'Felt√∂lt√©s...');
            document.getElementById('upload-log').innerHTML = '';
            
            try {
                // Teszt JSON k√©pekkel (base64)
                const testSessionData = {
                    sessionCode: testSessionCode,
                    subject: 'test',
                    className: 'Teszt Oszt√°ly',
                    createdAt: new Date().toISOString(),
                    exercises: [
                        {
                            id: 'test1',
                            fileName: 'teszt_kep_1.jpg',
                            imageUrl: 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/2wBDAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/wAARCAABAAEDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAv/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwA/wA==', // 1x1 pixel JPEG
                            title: 'Teszt Feladat 1',
                            instruction: 'Ez egy teszt feladat k√©ppel',
                            type: 'quiz',
                            content: { question: 'Teszt k√©rd√©s?', answers: ['A', 'B', 'C'], correct: 0 }
                        },
                        {
                            id: 'test2',
                            fileName: 'teszt_kep_2.jpg',
                            imageUrl: 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/2wBDAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/wAARCAABAAEDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAv/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwA/wA==', // 1x1 pixel JPEG
                            title: 'Teszt Feladat 2',
                            instruction: 'Ez egy m√°sik teszt feladat k√©ppel',
                            type: 'quiz',
                            content: { question: 'M√°sik teszt k√©rd√©s?', answers: ['X', 'Y', 'Z'], correct: 1 }
                        }
                    ],
                    metadata: {
                        version: '1.0.0',
                        totalExercises: 2,
                        hasImages: true
                    }
                };

                log('upload-log', `JSON felt√∂lt√©se: ${testSessionCode}`);
                log('upload-log', `Feladatok sz√°ma: ${testSessionData.exercises.length}`);
                log('upload-log', `K√©pek sz√°ma: ${testSessionData.exercises.filter(ex => ex.imageUrl).length}`);
                log('upload-log', `JSON m√©ret: ${Math.round(JSON.stringify(testSessionData).length / 1024)} KB`);
                
                const response = await fetch('/api/simple-api/sessions/upload-drive', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code: testSessionCode,
                        sessionJson: testSessionData
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`HTTP ${response.status}: ${errorData.error || response.statusText}`);
                }

                const data = await response.json();
                log('upload-log', `Felt√∂lt√©s sikeres: ${data.fileName}`);
                log('upload-log', `File ID: ${data.fileId}`);
                log('upload-log', `Let√∂lt√©si URL: ${data.downloadUrl}`);

                setStatus('upload-status', 'ok', '‚úÖ Felt√∂lt√©s OK');
                testResults.upload = true;
            } catch (error) {
                setStatus('upload-status', 'fail', '‚ùå Felt√∂lt√©s hiba');
                log('upload-log', `Hiba: ${error.message}`, true);
            }
        }

        async function testJsonDownload() {
            if (!testSessionCode) {
                setStatus('download-status', 'fail', '‚ùå Nincs munkamenet');
                log('download-log', 'El≈ëbb hozz l√©tre √©s t√∂ltsd fel a munkamenetet!', true);
                return;
            }

            setStatus('download-status', 'pending', 'Let√∂lt√©s...');
            document.getElementById('download-log').innerHTML = '';
            
            try {
                log('download-log', `JSON let√∂lt√©se: ${testSessionCode}`);
                
                const response = await fetch(`/api/simple-api/sessions/${testSessionCode}/download-json`);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`HTTP ${response.status}: ${errorData.error || response.statusText}`);
                }

                const sessionData = await response.json();
                log('download-log', `Let√∂lt√©s sikeres!`);
                log('download-log', `Munkamenet k√≥d: ${sessionData.sessionCode}`);
                log('download-log', `Feladatok sz√°ma: ${sessionData.exercises?.length || 0}`);
                
                const exercisesWithImages = sessionData.exercises?.filter(ex => ex.imageUrl && ex.imageUrl.length > 0) || [];
                log('download-log', `K√©pek sz√°ma: ${exercisesWithImages.length}`);
                
                if (exercisesWithImages.length > 0) {
                    log('download-log', `Els≈ë k√©p m√©rete: ${exercisesWithImages[0].imageUrl.length} karakter`);
                    log('download-log', `K√©p t√≠pus: ${exercisesWithImages[0].imageUrl.substring(0, 30)}...`);
                }

                if (sessionData.exercises && sessionData.exercises.length > 0 && exercisesWithImages.length > 0) {
                    setStatus('download-status', 'ok', '‚úÖ Let√∂lt√©s OK (k√©pekkel)');
                    testResults.download = true;
                } else if (sessionData.exercises && sessionData.exercises.length > 0) {
                    setStatus('download-status', 'fail', '‚ùå Nincs k√©p');
                    log('download-log', 'A feladatok let√∂lt≈ëdtek, de nincsenek k√©pek!', true);
                } else {
                    setStatus('download-status', 'fail', '‚ùå Nincs feladat');
                    log('download-log', 'Nem tal√°lhat√≥k feladatok!', true);
                }
            } catch (error) {
                setStatus('download-status', 'fail', '‚ùå Let√∂lt√©s hiba');
                log('download-log', `Hiba: ${error.message}`, true);
            }
        }

        async function runFullTest() {
            clearLogs();
            setStatus('final-status', 'pending', 'Tesztek futtat√°sa...');
            
            await testDatabaseConnection();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testSessionCreation();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testJsonUpload();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testJsonDownload();
            
            // V√©gs≈ë eredm√©ny
            const passedTests = Object.values(testResults).filter(result => result).length;
            const totalTests = Object.keys(testResults).length;
            
            if (passedTests === totalTests) {
                setStatus('final-status', 'ok', 'üéâ Minden teszt sikeres!');
                document.getElementById('final-summary').innerHTML = `
                    <div style="color: green; font-weight: bold;">
                        ‚úÖ A k√©pek bet√∂lt√©se M≈∞K√ñDIK!<br>
                        ‚úÖ A di√°kok l√°tni fogj√°k a k√©peket!<br>
                        üöÄ K√©szen √°ll a deployment!
                    </div>
                `;
            } else {
                setStatus('final-status', 'fail', `‚ùå ${totalTests - passedTests} teszt sikertelen`);
                document.getElementById('final-summary').innerHTML = `
                    <div style="color: red; font-weight: bold;">
                        ‚ùå A k√©pek bet√∂lt√©se NEM m≈±k√∂dik!<br>
                        ‚ùå A di√°kok NEM fogj√°k l√°tni a k√©peket!<br>
                        üîß Tov√°bbi jav√≠t√°sok sz√ºks√©gesek!
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>Sikertelen tesztek:</strong><br>
                        ${Object.entries(testResults).filter(([key, value]) => !value).map(([key]) => `‚Ä¢ ${key}`).join('<br>')}
                    </div>
                `;
            }
        }

        function clearLogs() {
            ['db-log', 'session-log', 'upload-log', 'download-log'].forEach(id => {
                document.getElementById(id).innerHTML = '';
                document.getElementById(id).style.display = 'none';
            });
            
            ['db-status', 'session-status', 'upload-status', 'download-status', 'final-status'].forEach(id => {
                setStatus(id, 'pending', 'V√°rakoz√°s...');
            });
            
            document.getElementById('final-summary').innerHTML = '';
            testResults = { database: false, session: false, upload: false, download: false };
            testSessionCode = null;
        }
    </script>
</body>
</html>